///////////////////////////////////////////////////////////////////////////////
//Modified Guard Module
///////////////////////////////////////////////////////////////////////////////

//Defines the intent text
expression #Intent_Guard_Caravan "guarding_caravan"

//Guard module
function guard_check(agent thisagent, string whattype, string whattoguard, integer chance) is Boolean

declare
	list potentials;
	agent best_one;
	agent diddly;
	list new_potentials,guards;
	integer range;

begin
//	$debugout("Should I guard",whattoguard,"?");

	if ($randomnumber(100) + 1 > chance)
		begin
//			$debugout("No - not interested.");
			return FALSE;
		end

	range = $getattribute(thisagent,#ATTRIB_sightrange) * 10;

	//potentials = $listtitlesinRadius(thisagent,whattype,whattoguard,range);

	$ListObjects (ThisAgent, WhatType, Range, Potentials, #CheckTitles, WhatToGuard);

	foreach diddly in potentials do
		begin
			//guards = $listtitlesinradius(diddly,"hero",thisagent's "title",range);

			if ($ListObjects (Diddly, "Hero", Range, Guards, #CheckTitles, ThisAgent's "Title") < 4)
				new_potentials << diddly;
		end

	potentials = new_potentials;

	if ($listsize(potentials) < 1)
		begin
//			$debugout("No unguarded ",whattoguard," on map.");
			return FALSE;
		end

	 Best_One = $ListMember (Potentials, 1);
	//best_one = $pick_closest(thisagent,potentials);

  //	if ($distanceBetweenAgents(thisagent,best_one) < (10 * $getattribute(thisagent,#ATTRIB_Sightrange)))
	 //	begin
			thisagent's "Activescript" = $defend_object;
			thisagent's "target" = best_one;
			thisagent's "taskname" = "defending";
			$SpecifyIntent(ThisAgent, #Intent_Guard_Caravan);
//			best_one's "num_guards" += 1;
//			$debugout("Yes!");
			return TRUE;
	  //	end

//	$debugout("Not near enough.");
	return False;
end